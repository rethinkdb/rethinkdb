#!/usr/bin/python
# This script will generate parameter files for use by jenkins' paramaterized trigger plugin
#  to launch a job for each test generated by the files in the given directory
# The directory you probably want is "rethinkdb/test/full_test"
# One file will be created for each test in the selected output directory (default is cwd)

import os, traceback, optparse

parser = optparse.OptionParser()
parser.add_option("--test-dir", action="store", dest = "test_dir")
parser.add_option("--output-dir", action="store", dest="output_dir")
parser.set_defaults(output_dir = ".")
(options, args) = parser.parse_args()
assert not args

if options.test_dir is None:
    parser.error("You must specify --test-dir");

tests_as_list = [ ]

def generate_test(test_command, repeat, inputs):
    # repeat and dependencies are controlled by jenkins, so these values are not used
    tests_as_list.append(test_command.replace("$RETHINKDB", ".."))

for (dirpath, dirname, filenames) in os.walk(options.test_dir):
    for filename in filenames:
        full_path = os.path.join(dirpath, filename)
        print "Reading specification file %r" % full_path
        try:
            execfile(full_path, {"__builtins__": __builtins__, "generate_test": generate_test})
        except Exception, e:
            traceback.print_exc()

tests_as_list.sort()

for number, test_command in enumerate(tests_as_list):
    f = open("%s/test_%i.param" % (options.output_dir, number), 'w')
    f.write("TEST_COMMAND=%s\n" % test_command)
    f.write("TEST_ID=%i" % number)
    f.close()

