#!/bin/sh
set -e

bin_dir=BIN_DIR
man1_dir=MAN1_DIR
bash_completion_dir=BASH_COMPLETION_DIR
internal_bash_completion_dir=INTERNAL_BASH_COMPLETION_DIR
server_exec_name=SERVER_EXEC_NAME
server_exec_name_versioned=SERVER_EXEC_NAME_VERSIONED
priority=PRIORITY

DATA_DIR=/var/lib/rethinkdb

case "$1" in
  configure)
    if ! getent group rethinkdb >/dev/null; then
      addgroup --system rethinkdb >/dev/null
    fi

    if ! getent passwd rethinkdb >/dev/null; then
      adduser --system --disabled-login --ingroup rethinkdb --home "$DATA_DIR" --no-create-home rethinkdb >/dev/null
    fi

    if [ ! -d "$DATA_DIR" ]; then
      /usr/bin/rethinkdb create -d "$DATA_DIR"
      chown -R rethinkdb:rethinkdb "$DATA_DIR"
    fi

    # update-alternatives is idempotent (in the sence described in the Debian Policy Manual: Package maintainer scripts and installation procedure)
    # prerm script could delete the link in case of abort-*, so we need to recreate it again.
    if [ UPDATE_ALTERNATIVES = 1 ]; then
      update-alternatives \
        --install $bin_dir/$server_exec_name $server_exec_name $bin_dir/$server_exec_name_versioned $priority \
        --slave $man1_dir/$server_exec_name.1.gz $server_exec_name.1.gz $man1_dir/$server_exec_name_versioned.1.gz \
        --slave $bash_completion_dir/$server_exec_name.bash $server_exec_name.bash $internal_bash_completion_dir/$server_exec_name.bash
    fi

    service rethinkdb start
    ;;

  abort-upgrade|abort-remove|abort-deconfigure)
    ;;
  *)
    echo "Warning: RethinkDB postinst script called with unknown set of arguments: $*"
    ;;
esac
