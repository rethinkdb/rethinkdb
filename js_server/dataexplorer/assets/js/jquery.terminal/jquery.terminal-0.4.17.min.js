/*

 |       __ _____                     ________                              __
 |      / // _  /__ __ _____ ___ __ _/__  ___/__ ___ ______ __ __  __ ___  / /
 |  __ / // // // // // _  // _// // / / // _  // _//     // //  \/ // _ \/ /
 | /  / // // // // // ___// / / // / / // ___// / / / / // // /\  // // / /__
 | \___//____ \\___//____//_/ _\_  / /_//____//_/ /_/ /_//_//_/ /_/ \__\_\___/
 |           \/              /____/                              version 0.4.17
 http://terminal.jcubic.pl

 Licensed under GNU LGPL Version 3 license
 Copyright (c) 2011 Jakub Jankiewicz <http://jcubic.pl>

 Includes:

 Storage plugin Distributed under the MIT License
 Copyright (c) 2010 Dave Schindler

 jQuery Timers licenced with the WTFPL
 <http://jquery.offput.ca/every/>

 Cross-Browser Split 1.1.1
 Copyright 2007-2012 Steven Levithan <stevenlevithan.com>
 Available under the MIT License

 Date: Sun, 24 Jun 2012 13:42:07 +0000
*/
Array.prototype.has=function(m){for(var E=this.length;E--;)if(this[E]===m)return true;return false};function get_stack(m){return m?[m.toString().match(/.*\n.*\n/)].concat(get_stack(m.caller)):[]}
(function(m,E){function ha(c,e){var f;if(typeof c==="string"&&typeof e==="string"){localStorage[c]=e;return true}else if(typeof c==="object"&&typeof e==="undefined"){for(f in c)if(c.hasOwnProperty(f))localStorage[f]=c[f];return true}return false}function ba(c,e){var f,h;f=new Date;f.setTime(f.getTime()+31536E6);f="; expires="+f.toGMTString();if(typeof c==="string"&&typeof e==="string"){document.cookie=c+"="+e+f+"; path=/";return true}else if(typeof c==="object"&&typeof e==="undefined"){for(h in c)if(c.hasOwnProperty(h))document.cookie=
h+"="+c[h]+f+"; path=/";return true}return false}function ia(c){return localStorage[c]}function ja(c){var e,f,h;c+="=";e=document.cookie.split(";");for(f=0;f<e.length;f++){for(h=e[f];h.charAt(0)===" ";)h=h.substring(1,h.length);if(h.indexOf(c)===0)return h.substring(c.length,h.length)}return null}function ka(c){return delete localStorage[c]}function la(c){return ba(c,"",-1)}function X(c,e){var f=[],h=c.length;if(h<e)return[c];for(var j=0;j<h;j+=e)f.push(c.substring(j,j+e));return f}function H(c){if(typeof c===
"string"){c=c.replace(/&(?!#[0-9]+;|[a-zA-Z]+;)/g,"&amp;");c=c.replace(/</g,"&lt;").replace(/>/g,"&gt;");c=c.replace(/\n/g,"<br/>");c=c.replace(/ /g,"&nbsp;");c=c.replace(/\t/g,"&nbsp;&nbsp;&nbsp;&nbsp;");var e=c.split(ma);if(e.length>1)c=m.map(e,function(f){return f===""?f:f.substring(0,1)==="["?f.replace(Y,function(h,j,s,w,o){if(o==="")return"<span>&nbsp;</span>";h="";if(j.indexOf("b")!==-1)h+="font-weight:bold;";var D="text-decoration:";if(j.indexOf("u")!==-1)D+="underline ";if(j.indexOf("s")!==
-1)D+="line-through";if(j.indexOf("s")!==-1||j.indexOf("u")!==-1)h+=D+";";if(j.indexOf("i")!==-1)h+="font-style:italic; ";if(s.match(ca))h+="color:"+s+";";if(w.match(ca))h+="background-color:"+w;return c='<span style="'+h+'">'+o+"</span>"}):"<span>"+f+"</span>"}).join("");return c}else return""}function da(c){var e=c instanceof Array?c:c?[c]:[],f=0;m.extend(this,{left:function(){if(f===0)f=e.length-1;else--f;return e[f]},right:function(){if(f===e.length-1)f=0;else++f;return e[f]},current:function(){return e[f]},
data:function(){return e},length:function(){return e.length},reset:function(){f=0},append:function(h){e.push(h);this.reset()}})}function na(c){var e=c?[c]:[];m.extend(this,{size:function(){return e.length},pop:function(){if(e.length===0)return null;else{var f=e[e.length-1];e=e.slice(0,e.length-1);return f}},push:function(f){e=e.concat([f]);return f},top:function(){return e.length>0?e[e.length-1]:null}})}function oa(c){var e=true;if(typeof c==="string"&&c!=="")c+="_";var f=m.Storage.get(c+"commands"),
h=new da(f?eval("("+f+")"):[""]);m.extend(this,{append:function(j){if(e&&h.current()!==j){h.append(j);m.Storage.set(c+"commands",m.json_stringify(h.data()))}},data:function(){return h.data()},next:function(){return h.right()},last:function(){h.reset()},previous:function(){return h.left()},clear:function(){h=new da;m.Storage.remove(c+"commands")},enable:function(){e=true},disable:function(){e=false}})}var T=typeof window.localStorage!=="undefined";m.extend({Storage:{set:T?ha:ba,get:T?ia:ja,remove:T?
ka:la}});jQuery.fn.extend({everyTime:function(c,e,f,h,j){return this.each(function(){jQuery.timer.add(this,c,e,f,h,j)})},oneTime:function(c,e,f){return this.each(function(){jQuery.timer.add(this,c,e,f,1)})},stopTime:function(c,e){return this.each(function(){jQuery.timer.remove(this,c,e)})}});jQuery.extend({timer:{guid:1,global:{},regex:/^([0-9]+)\s*(.*s)?$/,powers:{ms:1,cs:10,ds:100,s:1E3,das:1E4,hs:1E5,ks:1E6},timeParse:function(c){if(c===E||c===null)return null;var e=this.regex.exec(jQuery.trim(c.toString()));
return e[2]?parseInt(e[1],10)*(this.powers[e[2]]||1):c},add:function(c,e,f,h,j,s){var w=0;if(jQuery.isFunction(f)){j||(j=h);h=f;f=e}e=jQuery.timer.timeParse(e);if(!(typeof e!=="number"||isNaN(e)||e<=0)){if(j&&j.constructor!==Number){s=!!j;j=0}j=j||0;s=s||false;if(!c.$timers)c.$timers={};c.$timers[f]||(c.$timers[f]={});h.$timerID=h.$timerID||this.guid++;var o=function(){if(!(s&&this.inProgress)){this.inProgress=true;if(++w>j&&j!==0||h.call(c,w)===false)jQuery.timer.remove(c,f,h);this.inProgress=false}};
o.$timerID=h.$timerID;c.$timers[f][h.$timerID]||(c.$timers[f][h.$timerID]=window.setInterval(o,e));this.global[f]||(this.global[f]=[]);this.global[f].push(c)}},remove:function(c,e,f){var h=c.$timers,j;if(h){if(e){if(h[e]){if(f){if(f.$timerID){window.clearInterval(h[e][f.$timerID]);delete h[e][f.$timerID]}}else for(var s in h[e])if(h[e].hasOwnProperty(s)){window.clearInterval(h[e][s]);delete h[e][s]}for(j in h[e])if(h[e].hasOwnProperty(j))break;if(!j){j=null;delete h[e]}}}else for(var w in h)h.hasOwnProperty(w)&&
this.remove(c,w,f);for(j in h)if(h.hasOwnProperty(j))break;if(!j)c.$timers=null}}}});if(jQuery.browser.msie)jQuery(window).one("unload",function(){var c=jQuery.timer.global,e;for(e in c)if(c.hasOwnProperty(e))for(var f=c[e],h=f.length;--h;)jQuery.timer.remove(f[h],e)});var ea;ea=ea||function(c){var e=String.prototype.split,f=/()??/.exec("")[1]===c,h;h=function(j,s,w){if(Object.prototype.toString.call(s)!=="[object RegExp]")return e.call(j,s,w);var o=[],D=(s.ignoreCase?"i":"")+(s.multiline?"m":"")+
(s.extended?"x":"")+(s.sticky?"y":""),y=0,J,x,F;s=RegExp(s.source,D+"g");j+="";f||(J=RegExp("^"+s.source+"$(?!\\s)",D));for(w=w===c?4294967295:w>>>0;x=s.exec(j);){D=x.index+x[0].length;if(D>y){o.push(j.slice(y,x.index));!f&&x.length>1&&x[0].replace(J,function(){for(var I=1;I<arguments.length-2;I++)if(arguments[I]===c)x[I]=c});x.length>1&&x.index<j.length&&Array.prototype.push.apply(o,x.slice(1));F=x[0].length;y=D;if(o.length>=w)break}s.lastIndex===x.index&&s.lastIndex++}if(y===j.length){if(F||!s.test(""))o.push("")}else o.push(j.slice(y));
return o.length>w?o.slice(0,w):o};String.prototype.split=function(j,s){return h(this,j,s)};return h}();var ma=/(\[\[[bius]*;[^;]*;[^\]]*\][^\]\[]*\])/g,Y=/\[\[([bius]*);([^;]*);([^\]]*)\]([^\]\[]*)\]/g,ca=/#([0-9A-Fa-f]{3}|[0-9A-Fa-f]{6})/;m.json_stringify=function(c,e){var f="",h;e=e===E?1:e;switch(typeof c){case "function":f+=c;break;case "boolean":f+=c?"true":"false";break;case "object":if(c===null)f+="null";else if(c instanceof Array){f+="[";var j=c.length;for(h=0;h<j-1;++h)f+=m.json_stringify(c[h],
e+1);f+=m.json_stringify(c[j-1],e+1)+"]"}else{f+="{";for(j in c)if(c.hasOwnProperty(j))f+='"'+j+'":'+m.json_stringify(c[j],e+1);f+="}"}break;case "string":j=c;var s={"\\\\":"\\\\",'"':'\\"',"/":"\\/","\\n":"\\n","\\r":"\\r","\\t":"\\t"};for(h in s)if(s.hasOwnProperty(h))j=j.replace(RegExp(h,"g"),s[h]);f+='"'+j+'"';break;case "number":f+=String(c)}f+=e>1?",":"";if(e===1)f=f.replace(/,([\]}])/g,"$1");return f.replace(/([\[{]),/g,"$1")};m.fn.cmd=function(c){function e(){l.toggleClass("inverted")}function f(){C=
"(reverse-i-search)`"+F+"': ";K()}function h(d){var r=G.data(),M=RegExp("^"+F),z=r.length;if(d&&I>0)z-=I;for(d=z;d--;)if(M.test(r[d])){I=r.length-d;q=0;o.set(r[d],true);A();break}}function j(d){var r=d.substring(0,y-J);d=d.substring(y-J);return[r].concat(X(d,y))}function s(){D.focus();o.oneTime(1,function(){o.insert(D.val());D.blur().val("")})}function w(d){if(c.keydown&&c.keydown(d)===false)return false;if(N){var r;if(x&&(d.which===35||d.which===36||d.which===37||d.which===38||d.which===39||d.which===
40||d.which===66||d.which===13||d.which===27)){C=U;x=false;I=null;F="";K();if(d.which===27)a="";A();w.call(this,d)}else if(d.altKey){if(d.which===68){o.set(a.slice(0,q)+a.slice(q).replace(/[^ ]+ |[^ ]+$/,""),true);return false}return true}else if(d.keyCode===13){if(G&&a&&(c.historyFilter&&c.historyFilter(a)||!c.historyFilter))G.data().slice(-1)[0]!==a&&G.append(a);G.last();d=a;o.set("");c.commands&&c.commands(d);typeof C==="function"&&K()}else if(d.which===32)if(x){F+=" ";f()}else o.insert(" ");else if(d.which===
8)if(x){F=F.slice(0,-1);f()}else{if(a!==""&&q>0){a=a.slice(0,q-1)+a.slice(q,a.length);--q;A()}}else if(d.which===9&&!(d.ctrlKey||d.altKey))o.insert("\t");else if(d.which===46){if(a!==""&&q<a.length){a=a.slice(0,q)+a.slice(q+1,a.length);A()}return true}else if(G&&d.which===38||d.which===80&&d.ctrlKey)o.set(G.previous());else if(G&&d.which===40||d.which===78&&d.ctrlKey)o.set(G.next());else if(d.which===37||d.which===66&&d.ctrlKey)if(d.ctrlKey&&d.which!==66){r=q-1;d=0;for(a[r]===" "&&--r;r>0;--r)if(a[r]===
" "&&a[r+1]!==" "){d=r+1;break}else if(a[r]==="\n"&&a[r+1]!=="\n"){d=r;break}o.position(d)}else{if(q>0){--q;A()}}else if(d.which===82&&d.ctrlKey)if(x)h(true);else{U=C;f();a="";A();x=true}else if(d.which===39||d.which===70&&d.ctrlKey)if(d.ctrlKey&&d.which!==70){a[q]===" "&&++q;d=a.slice(q).match(/\S[\n\s]{2,}|[\n\s]+\S?/);if(!d||d[0].match(/^\s+$/))q=a.length;else if(d[0][0]!==" ")q+=d.index+1;else{q+=d.index+d[0].length-1;d[0][d[0].length-1]!==" "&&--q}A()}else{if(q<a.length){++q;A()}}else if(d.which===
123)return true;else if(d.which===36)o.position(0);else if(d.which===35)o.position(a.length);else if(d.ctrlKey||d.metaKey)if(d.shiftKey){if(d.which===84)return true}else if(d.which===65)o.position(0);else if(d.which===69)o.position(a.length);else if(d.which===88||d.which===67||d.which===87||d.which===84)return true;else if(d.which===86){s();return true}else if(d.which===75)if(q===0)o.set("");else q!==a.length&&o.set(a.slice(0,q));else if(d.which===85){o.set(a.slice(q,a.length));o.position(0)}else{if(d.which===
17)return true}else return true;return false}}var o=this;o.addClass("cmd");o.append('<span class="prompt"></span><span></span><span class="cursor">&nbsp;</span><span></span>');var D=m("<textarea/>").addClass("clipboard").appendTo(o);c.width&&o.width(c.width);var y,J,x=false,F="",I=null,U,V=c.mask||false,a="",q=0,C,N=c.enabled,O,G,l=o.find(".cursor"),A=function(d){function r(g,p){if(p===g.length){b.html(H(g));l.html("&nbsp;");i.html("")}else if(p===0){b.html("");l.html(H(g.slice(0,1)));i.html(H(g.slice(1)))}else{var k=
H(g.slice(0,p));b.html(k);k=g.slice(p,p+1);l.html(k===" "?"&nbsp;":H(k));p===g.length-1?i.html(""):i.html(H(g.slice(p+1)))}}function M(g){return"<div>"+H(g)+"</div>"}function z(g){var p=i;m.each(g,function(k,n){p=m(M(n)).insertAfter(p).addClass("clear")})}function t(g){m.each(g,function(p,k){b.before(M(k))})}var b=l.prev(),i=l.next();return function(){var g=V?a.replace(/./g,"*"):a,p,k;d.find("div").remove();b.html("");if(g.length>y-J-1||g.match(/\n/)){var n,u=g.match(/\t/g),B=u?u.length*3:0;if(u)g=
g.replace(/\t/g,"\u0000\u0000\u0000\u0000");if(g.match(/\n/)){var v=g.split("\n");k=y-J-1;for(p=0;p<v.length-1;++p)v[p]+=" ";if(v[0].length>k){n=[v[0].substring(0,k)];n=n.concat(X(v[0].substring(k),y))}else n=[v[0]];for(p=1;p<v.length;++p)if(v[p].length>y)n=n.concat(X(v[p],y));else n.push(v[p])}else n=j(g);if(u)n=m.map(n,function(Z){return Z.replace(/\x00\x00\x00\x00/g,"\t")});k=n[0].length;if(q<k){r(n[0],q);z(n.slice(1))}else if(q===k){b.before(M(n[0]));r(n[1],0);z(n.slice(2))}else{p=n.length;if(q<
k){r(n[0],q);z(n.slice(1))}else if(q===k){b.before(M(n[0]));r(n[1],0);z(n.slice(2))}else{u=n.slice(-1)[0];v=g.length-q;var L=u.length;g=0;if(v<=L){t(n.slice(0,-1));r(u,(L===v?0:L-v)+B)}else if(p===3){b.before("<div>"+H(n[0])+"</div>");r(n[1],q-k-1);i.after('<div class="clear">'+H(n[2])+"</div>")}else{g=q;for(p=0;p<n.length;++p){k=n[p].length;if(g>k)g-=k;else break}k=n[p];B=p;if(g===k.length){g=0;k=n[++B]}r(k,g);t(n.slice(0,B));z(n.slice(B+1))}}}}else if(g===""){b.html("");l.html("&nbsp;");i.html("")}else r(g,
q)}}(o),K=function(){var d=o.find(".prompt");return function(){if(typeof C==="string"){J=C.replace(Y,"$4").length;d.html(H(C))}else C(function(r){J=r.replace(Y,"$4").length;d.html(H(r))})}}();m.extend(o,{name:function(d){if(d!==E){O=d;G=new oa(d)}else return O},history:function(){return G},set:function(d,r){if(d!==E){a=d;if(!r)q=a.length;A();if(typeof c.onCommandChange==="function")c.onCommandChange(a)}},insert:function(d,r){if(q===a.length)a+=d;else a=q===0?d+a:a.slice(0,q)+d+a.slice(q);r||(q+=d.length);
A();if(typeof c.onCommandChange==="function")c.onCommandChange(a)},get:function(){return a},commands:function(d){if(d)c.commands=d;else return d},destroy:function(){m(document.documentElement).unbind(".commandline");o.find(".prompt").remove()},prompt:function(d){if(d===E)return C;else{if(typeof d==="string"||typeof d==="function")C=d;else throw"prompt must be a function or string";K();A()}},position:function(d){if(typeof d==="number"){q=d<0?0:d>a.length?a.length:d;A()}else return q},show:function(){var d=
o.show;return function(){d.apply(o,[]);A();K()}}(),resize:function(d){if(d)y=d;else{d=o.width();var r=l.innerWidth();y=Math.floor(d/r)}A()},enable:function(){if(!N){l.addClass("inverted");o.everyTime(500,"blink",e);N=true}},isenabled:function(){return N},disable:function(){if(N){o.stopTime("blink",e);l.removeClass("inverted");N=false}},mask:function(d){if(typeof d==="boolean"){V=d;A()}else return V}});o.name(c.name||"");C=c.prompt||"> ";K();if(c.enabled===E||c.enabled===true)o.enable();m(m.browser.msie?
document.documentElement:window).keypress(function(d){var r;if(d.ctrlKey&&d.which===99)return true;if(!x&&c.keypress)r=c.keypress(d);if(r===E||r){if(N)if([38,32,13,0,8].has(d.which)&&d.keyCode!==123&&!(d.which===38&&d.shiftKey))return false;else if(!d.ctrlKey&&!(d.altKey&&d.which===100)){if(x){F+=String.fromCharCode(d.which);f();h()}else o.insert(String.fromCharCode(d.which));return false}else if(d.altKey)if(x){F+=String.fromCharCode(d.which);f();h()}else o.insert(String.fromCharCode(d.which))}else return r}).keydown(w);
return o};m.jrpc=function(c,e,f,h,j,s){e=m.json_stringify({jsonrpc:"2.0",method:f,params:h,id:e});return m.ajax({url:c,data:e,success:j,error:s,contentType:"application/json",dataType:"json",async:true,cache:false,type:"POST"})};T=/ {14}$/;var pa=[["jQuery Terminal","(c) 2011 jcubic"],["jQuery Terminal Emulator v. 0.4.17","Copyright (c) 2011 Jakub Jankiewicz <http://jcubic.pl>".replace(/ *<.*>/,"")],["jQuery Terminal Emulator version version 0.4.17","Copyright (c) 2011 Jakub Jankiewicz <http://jcubic.pl>"],
["      _______                 ________                        __","     / / _  /_ ____________ _/__  ___/______________  _____  / /"," __ / / // / // / _  / _/ // / / / _  / _/     / /  \\/ / _ \\/ /","/  / / // / // / ___/ // // / / / ___/ // / / / / /\\  / // / /__","\\___/____ \\\\__/____/_/ \\__ / /_/____/_//_/ /_/ /_/  \\/\\__\\_\\___/","         \\/          /____/                                   ".replace(T,"")+"version 0.4.17","Copyright (c) 2011 Jakub Jankiewicz <http://jcubic.pl>"],
["      __ _____                     ________                              __","     / // _  /__ __ _____ ___ __ _/__  ___/__ ___ ______ __ __  __ ___  / /"," __ / // // // // // _  // _// // / / // _  // _//     // //  \\/ // _ \\/ /","/  / // // // // // ___// / / // / / // ___// / / / / // // /\\  // // / /__","\\___//____ \\\\___//____//_/ _\\_  / /_//____//_/ /_/ /_//_//_/ /_/ \\__\\_\\___/","          \\/              /____/                                          ".replace(T,"")+"version 0.4.17",
"Copyright (c) 2011 Jakub Jankiewicz <http://jcubic.pl>"]],$=[],P=new function(c){var e=c?[c]:[],f=0;m.extend(this,{rotate:function(){if(e.length===1)return e[0];else{if(f===e.length-1)f=0;else++f;return e[f]}},length:function(){return e.length},set:function(h){for(var j=e.length;j--;)if(e[j]===h){f=j;return}this.append(h)},front:function(){return e[f]},append:function(h){e.push(h)}})};m.fn.terminal=function(c,e){function f(){return a.get(0).scrollHeight>a.innerHeight()}function h(){var b=a.find(".cursor").width(),
i=Math.floor(a.width()/b);if(f()){var g=a.innerWidth()-a.width();i-=Math.ceil((20-g/2)/(b-1))}return i}function j(b,i){a.error("&#91;"+i+"&#93;: "+(typeof b==="string"?b:typeof b.fileName==="string"?b.fileName+": "+b.message:b.message));a.pause();typeof b.fileName==="string"&&m.get(b.fileName,function(g){a.resume();var p=b.lineNumber-1;(g=g.split("\n")[p])&&a.error("&#91;"+b.lineNumber+"&#93;: "+g)})}function s(b,i){try{if(typeof i==="function")i(function(){});else if(typeof i!=="string")throw b+
" must be string or function";}catch(g){j(g,b.toUpperCase());return false}return true}function w(){var b=a.prop?a.prop("scrollHeight"):a.attr("scrollHeight");a.scrollTop(b)}function o(b){b=typeof b==="string"?b:String(b);var i,g,p;if(b.length>O){i=O;g=b.split(/\n/g);p=/(\[\[[bius]*;[^;]*;[^\]]*\][^\]\[]*\]?)/g;var k=/(\[\[[bius]*;[^;]*;[^\]]*\])/,n=/\[\[[bius]*;?[^;]*;?[^\]]*\]?$/,u=false,B=false,v="";b=[];for(var L=0,Z=g.length;L<Z;++L){if(v!=="")if(g[L]===""){b.push(v+"]");continue}else{g[L]=v+
g[L];v=""}else if(g[L]===""){b.push("");continue}for(var W=g[L],fa=0,aa=0,R=0,ga=W.length;R<ga;++R){if(W[R]==="["&&W[R+1]==="[")u=true;else if(u&&W[R]==="]")if(B)B=u=false;else B=true;else if(u&&B||!u)++aa;if(aa===i||R===ga-1){var Q=W.substring(fa,R+1);if(v){Q=v+Q;if(Q.match("]"))v=""}fa=R+1;aa=0;var S=Q.match(p);if(S){S=S[S.length-1];if(S[S.length-1]!=="]"){v=S.match(k)[1];Q+="]"}else if(Q.match(n)){Q=Q.replace(n,"");v=S.match(k)[1]}}b.push(Q)}}}i=m("<div></div>");g=0;for(p=b.length;g<p;++g)b[g]===
""||b[g]==="\r"?i.append("<div>&nbsp;</div>"):m("<div/>").html(H(b[g])).appendTo(i)}else i=m("<div/>").html(H(b));C.append(i);i.width("100%");w();return i}function D(b,i){var g=1,p=function(k,n){i.pause();m.jrpc(b,g++,k,n,function(u){if(u.error)i.error("&#91;RPC&#93; "+u.error.message);else if(typeof u.result==="string")i.echo(u.result);else if(u.result instanceof Array)i.echo(u.result.join(" "));else if(typeof u.result==="object"){var B="",v;for(v in u.result)if(u.result.hasOwnProperty(v))B+=v+": "+
u.result[v]+"\n";i.echo(B)}i.resume()},function(u,B){i.error("&#91;AJAX&#93; "+B+" - Server reponse is: \n"+u.responseText);i.resume()})};return function(k,n){if(k!==""){var u,B;if(k.match(/[^ ]* /)){k=k.split(/ +/);u=k[0];B=k.slice(1)}else{u=k;B=[]}if(!l.login||u==="help")p(u,B);else{var v=n.token();v?p(u,[v].concat(B)):n.error("&#91;AUTH&#93; Access denied (no token)")}}}}function y(b){var i=t.prompt();if(t.mask())b=b.replace(/./g,"*");typeof i==="function"?i(function(g){a.echo(g+b)}):a.echo(i+
b)}function J(b){try{var i=z.top();if(b==="exit"&&l.exit)if(z.size()===1)if(l.login)F();else{y(b);a.echo("You can exit from main interpeter")}else a.pop("exit");else{y(b);b==="clear"&&l.clear?a.clear():i.eval(b,a)}}catch(g){j(g,"USER");a.resume();throw g;}}function x(){var b=null;t.prompt("login: ");l.history&&t.history().disable();t.commands(function(i){try{y(i);if(b){t.mask(false);a.pause();if(typeof l.login!=="function")throw"Value of login property must be a function";l.login(b,i,function(p){if(p){var k=
l.name;k=k?"_"+k:"";m.Storage.set("token"+k,p);m.Storage.set("login"+k,b);t.commands(J);U()}else{a.error("Wrong password try again");t.prompt("login: ");b=null}a.resume();l.history&&t.history().enable()})}else{b=i;t.prompt("password: ");t.mask(true)}}catch(g){j(g,"LOGIN",a);throw g;}})}function F(){var b=l.name;b=b?"_"+b:"";m.Storage.remove("token"+b,null);m.Storage.remove("login"+b,null);l.history&&t.history().disable();x()}function I(){var b=z.top(),i="";if(b.name!==E&&b.name!=="")i+=b.name+"_";
i+=N;t.name(i);b.prompt.constructor===Function?t.prompt(function(g){b.prompt(g,a)}):t.prompt(b.prompt);l.history&&t.history().enable();t.set("");if(typeof b.onStart==="function")b.onStart(a)}function U(){I();if(e.greetings===E)a.echo(a.signature);else e.greetings&&a.echo(e.greetings);if(typeof l.onInit==="function")l.onInit(a)}function V(b){a.oneTime(5,function(){if(d!==f()){a.resize();d=f()}});if(a.paused()){if(l.cancelableAjax)if(b.which===68&&b.ctrlKey){for(b=$.length;b--;){var i=$[b];if(4!==i.readyState)try{i.abort()}catch(g){a.error("error in aborting ajax")}}a.resume();
return false}}else{if(l.keydown&&l.keydown(b,a)===false)return false;if(b.which!==9)K=0;if(b.which===68&&b.ctrlKey){if(t.get()==="")if(z.size()>1||l.login!==E)a.pop("");else{a.resume();a.echo("")}else a.set_command("");return false}else if(l.tabcompletion&&b.which===9){++K;i=t.get();if(!i.match(" ")){var p=RegExp("^"+i),k=z.top().command_list,n=[];for(b=k.length;b--;)p.test(k[b])&&n.push(k[b]);if(n.length===1)a.set_command(n[0]);else if(n.length>1)if(K>=2){y(i);a.echo(n.join("\t"));K=0}}return false}else if(b.which===
86&&b.ctrlKey){a.oneTime(1,function(){w()});return true}else if(b.which===9&&b.ctrlKey){P.length()>1&&a.focus(false);return false}else if(b.which===34)a.scroll(a.height());else b.which===33?a.scroll(-a.height()):a.attr({scrollTop:a.attr("scrollHeight")})}}var a=this,q=[],C,N=P.length(),O,G=[],l={name:"",prompt:"> ",history:true,exit:true,clear:true,enabled:true,cancelableAjax:true,login:null,tabcompletion:null,historyFilter:null,onInit:null,onExit:null,keypress:null,keydown:null};if(e){e.width&&a.width(e.width);
e.height&&a.height(e.height);m.extend(l,e)}var A=!l.enabled;if(a.length===0)throw'Sorry, but terminal said that "'+a.selector+'" is not valid selector!';a.ajaxSend(function(b,i){$.push(i)});if(a.data("terminal"))return a.data("terminal");C=m("<div>").addClass("terminal-output").appendTo(a);a.addClass("terminal").append("<div/>");m.extend(a,{clear:function(){C.html("");t.set("");q=[];a.attr({scrollTop:0});return a},paused:function(){return A},pause:function(){if(t){a.disable();t.hide()}return a},resume:function(){if(t){a.enable();
t.show();w()}return a},cols:function(){return O},rows:function(){return q.length},history:function(){return t.history()},next:function(){if(P.length()===1)return a;else{var b=a.offset().top;a.height();a.scrollTop();var i=a,g=m(window).scrollTop(),p=g+m(window).height(),k=m(i).offset().top;if(k+m(i).height()>=g&&k<=p){P.front().disable();b=P.rotate().enable();i=b.offset().top-50;m("html,body").animate({scrollTop:i},500);return b}else{a.enable();m("html,body").animate({scrollTop:b-50},500);return a}}},
focus:function(b){a.oneTime(1,function(){if(P.length()===1)b===false?a.disable():a.enable();else if(b===false)a.next();else{P.front().disable();P.set(a);a.enable()}});return a},enable:function(){O===E&&a.resize();if(A)if(t){t.enable();A=false}return a},disable:function(){if(t){A=true;t.disable()}return a},enabled:function(){return A},signature:function(){var b=a.cols();b=b<15?null:b<35?0:b<55?1:b<64?2:b<75?3:4;return b!==null?pa[b].join("\n")+"\n":""},version:function(){return"0.4.17"},get_command:function(){return t.get()},
insert:function(b){if(typeof b==="string"){t.insert(b);return a}else throw"insert function argument is not a string";},set_prompt:function(b){if(s("prompt",b)){b.constructor===Function?t.prompt(function(i){b(i,a)}):t.prompt(b);z.top().prompt=b}return a},get_prompt:function(){return z.top().prompt},set_command:function(b){t.set(b);return a},set_mask:function(b){t.mask(b);return a},get_output:function(b){return b?q:m.map(q,function(i,g){return typeof g==="function"?g():g}).get().join("\n")},resize:function(b,
i){if(b&&i){a.width(b);a.height(i)}O=h();t.resize(O);var g=C.detach();C.html("");m.each(q,function(p,k){o(k&&k.constructor===Function?k():k)});a.prepend(g);w();return a},echo:function(b){q.push(b);return o(typeof b==="function"?b():b)},error:function(b){a.echo("[[;#f00;]"+b.replace(/\[/g,"&#91;").replace(/\]/g,"&#93;")+"]")},scroll:function(b){var i;if(a.prop){b>a.prop("scrollTop")&&b>0&&a.prop("scrollTop",0);i=a.prop("scrollTop");a.prop("scrollTop",i+b)}else{b>a.attr("scrollTop")&&b>0&&a.attr("scrollTop",
0);i=a.attr("scrollTop");a.attr("scrollTop",i+b)}return a},logout:l.login?function(){for(;z.size()>1;)z.pop();F();return a}:function(){throw"You don't have login function";},token:l.login?function(){var b=l.name;return m.Storage.get("token"+(b?"_"+b:""))}:null,login_name:l.login?function(){var b=l.name;return m.Storage.get("login"+(b?"_"+b:""))}:null,name:function(){return l.name},push:function(b,i){if(!i.prompt||s("prompt",i.prompt)){if(typeof b==="string")b=D(i.eval,a);z.push(m.extend({eval:b},
i));I()}return a},pop:function(b){b!==E&&y(b);if(z.top().name===l.name){if(l.login){F();if(typeof l.onExit==="function")l.onExit(a)}}else{b=z.pop();I();if(typeof b.onExit==="function")b.onExit(a)}return a}});var K=0,d=f(),r;if(l.login&&typeof l.onBeforeLogin==="function")l.onBeforeLogin(a);if(c.constructor===String){r=c;c=D(c,a)}else if(c.constructor===Array)throw"You can't use array as eval";else if(typeof c==="object"){for(var M in c)c.hasOwnProperty(M)&&G.push(M);c=function b(i){return function(g){if(g!==
""){g=g.split(/ +/);var p=g[0],k=g.slice(1);g=i[p];var n=typeof g;if(n==="function")g.apply(a,k);else if(n==="object"||n==="string"){k=[];if(n==="object"){for(var u in g)g.hasOwnProperty(u)&&k.push(u);g=b(g)}a.push(g,{prompt:p+"> ",name:p,command_list:k})}else a.error("Command '"+p+"' Not Found")}}}(c)}else if(typeof c!=="function")throw'Unknow object "'+String(c)+'" passed as eval';if(r&&(typeof l.login==="string"||l.login))l.login=function(b){var i=1;return function(g,p,k){a.pause();m.jrpc(r,i++,
b,[g,p],function(n){a.resume();!n.error&&n.result?k(n.result):k(null)},function(n,u){a.resume();a.error("&#91;AJAX&#92; Response: "+u+"\n"+n.responseText)})}}(typeof l.login==="boolean"?"login":l.login);if(s("prompt",l.prompt)){var z=new na({name:l.name,eval:c,prompt:l.prompt,command_list:G,greetings:l.greetings}),t=a.find(".terminal-output").next().cmd({prompt:l.prompt,history:l.history,historyFilter:l.historyFilter,width:"100%",keydown:V,keypress:l.keypress?function(b){return l.keypress(b,a)}:null,
onCommandChange:function(b){if(typeof l.onCommandChange==="function")l.onCommandChange(b,a);w()},commands:J});P.append(a);l.enabled===true?a.focus():a.disable();m(window).resize(a.resize);a.click(function(){a.focus()});a.token&&!a.token()&&a.login_name&&!a.login_name()?x():U();typeof m.fn.init.prototype.mousewheel==="function"&&a.mousewheel(function(b,i){i>0?a.scroll(-40):a.scroll(40);return false},true)}a.data("terminal",a);return a}})(jQuery);
